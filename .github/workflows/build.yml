name: Realme GT Neo6 Kernel Builder

on:
  workflow_dispatch:
    inputs:
      SUSFS_ENABLED:
        description: "Enable SUSFS"
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    # ================== 空间优化 ==================
    - name: 清理构建空间
      uses: easimon/maximize-build-space@v2
      with:
        root-reserve-mb: 16384  # 16GB预留空间
        swap-reserve-mb: 6144

    # ================== 源码获取 ==================
    - name: 克隆内核源码
      uses: actions/checkout@v4
      with:
        repository: Iconkop/realme_gtneo6-AndroidV-kernel-source
        path: master
        fetch-depth: 0  # 需要完整提交历史

    # ================== 工具链配置 ==================
    - name: 安装Clang工具链
      run: |
        wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r450784d.tar.gz
        mkdir -p clang && tar xzf clang-r450784d.tar.gz -C clang
        echo "CLANG_PATH=$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_ENV

    # ================== 内核配置 ==================
    - name: 生成内核配置
      run: |
        cd kernel
        make O=out ARCH=arm64 defconfig  # 确认defconfig路径正确
        
        # 验证基地址配置
        if ! grep -q "CONFIG_PHYSICAL_START=0x80080000" out/.config; then
          sed -i 's/CONFIG_PHYSICAL_START=.*/CONFIG_PHYSICAL_START=0x80080000/' out/.config
        fi

    # ================== KernelSU集成 ==================
    - name: 集成KernelSU
      run: |
        cd kernel
        # 使用官方集成脚本
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        
        # 适配骁龙8s Gen3的DTS补丁
        patch -p1 < drivers/kernelsu/patchs/qcom_sm8635.patch || true

    # ================== SUSFS集成 ==================
    - name: 集成SUSFS
      if: ${{ inputs.SUSFS_ENABLED }}
      run: |
        cd kernel
        # 应用Realme专用补丁
        for patch in \
          fs/squashfs/0001-enable-susfs.patch \
          drivers/staging/0101-add-susfs-support.patch
        do
          curl -sO "https://your-patch-server/$patch" && patch -p1 < $(basename $patch)
        done

    # ================== 内核编译 ==================
    - name: 编译内核
      run: |
        cd kernel
        make -j$(nproc) O=out ARCH=arm64 \
          CC=clang \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-android- \
          LLVM=1 \
          LLVM_IAS=1 \
          Image.gz-dtb

        # 验证输出文件
        IMAGE_PATH="out/arch/arm64/boot/Image.gz-dtb"
        if [ ! -f "$IMAGE_PATH" ]; then
          echo "::error::内核镜像未生成！"
          exit 1
        fi
        if [ $(stat -c%s "$IMAGE_PATH") -lt 20971520 ]; then  # 20MB校验
          echo "::error::镜像大小异常！"
          exit 1
        fi

    # ================== 镜像打包 ==================
    - name: 生成刷机包
      run: |
        cd kernel
        # 使用高通专用参数
        python3 scripts/mkbootimg.py \
          --kernel out/arch/arm64/boot/Image.gz-dtb \
          --ramdisk ../initramfs.cpio.gz \
          --base 0x80080000 \
          --pagesize 4096 \
          --cmdline 'console=ttyMSM0,115200n8 androidboot.selinux=permissive' \
          --dtb out/arch/arm64/boot/dts/qcom/sm8635-realme-neo6.dtb \
          -o boot.img
        
        # 生成SHA256校验
        sha256sum boot.img > boot.img.sha256

    # ================== 产物上传 ==================
    - name: 上传构建结果
      uses: actions/upload-artifact@v4
      with:
        name: neo6-kernel-$(date +%Y%m%d)
        path: |
          kernel/boot.img
          kernel/boot.img.sha256
        retention-days: 3
