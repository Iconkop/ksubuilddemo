# GitHub Actions å·¥ä½œæµåç§°
name: Build Kernel with SukiSU-Ultra

# å·¥ä½œæµè§¦å‘æ¡ä»¶ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡
jobs:
  build:
    # ä»»åŠ¡åç§°
    name: Build Kernel for realme GT Neo6
    # è¿è¡Œä»»åŠ¡çš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest

    # ä»»åŠ¡æ‰§è¡Œçš„æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¦‚æœéœ€è¦è®¿é—®ä»“åº“å†…çš„è„šæœ¬æ–‡ä»¶ï¼‰
      - name: Checkout Workflow Repo
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘æ‰€éœ€çš„ä¾èµ–åŒ…
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential cpio curl flex git kmod libssl-dev libelf-dev squashfs-tools zip patch python3-pip

      # æ­¥éª¤3ï¼šå…‹éš† Proton Clang ç¼–è¯‘å™¨å·¥å…·é“¾
      - name: Clone Compiler Toolchain
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang-toolchain

      # æ­¥éª¤4ï¼šè®¾ç½®ç¼–è¯‘ç¯å¢ƒå˜é‡
      - name: Set Environment Variables
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "SUBARCH=arm64" >> $GITHUB_ENV
          echo "KBUILD_BUILD_USER=GitHubActions" >> $GITHUB_ENV
          echo "KBUILD_BUILD_HOST=CI" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "NM=llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
          echo "STRIP=llvm-strip" >> $GITHUB_ENV
          echo "PATH=$GITHUB_WORKSPACE/clang-toolchain/bin:$PATH" >> $GITHUB_ENV

      # æ­¥éª¤5ï¼šæ£€å‡ºå†…æ ¸æºä»£ç ï¼ˆä½¿ç”¨ sukisu åˆ†æ”¯ï¼‰
      - name: Checkout Kernel Source (sukisu branch)
        uses: actions/checkout@v4
        with:
          repository: realme-kernel-opensource/realme_gtneo6-AndroidV-kernel-source
          ref: master
          path: kernel-source
          fetch-depth: 1

      # æ­¥éª¤6ï¼šé›†æˆ SukiSU-Ultra (susfs)
      # åˆ‡æ¢åˆ°å†…æ ¸æºç ç›®å½•å¹¶æ‰§è¡Œå®˜æ–¹å®‰è£…è„šæœ¬
      - name: Integrate SukiSU-Ultra (susfs)
        working-directory: ./kernel-source
        run: |
          echo "âœ… Integrating SukiSU-Ultra..."
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
          echo "âœ… Integration complete."

      # æ­¥éª¤7ï¼šå¼€å§‹ç¼–è¯‘å†…æ ¸
      - name: Build Kernel
        working-directory: ./kernel-source
        run: |
          echo "âœ… Starting kernel build..."
          # é…ç½®å†…æ ¸ï¼šè¯·å°† 'vendor/sm8650_defconfig' æ›¿æ¢ä¸ºæ‚¨è®¾å¤‡å®é™…çš„ defconfig æ–‡ä»¶
          make O=out vendor/pineapple_GKI.config
          
          # æ‰§è¡Œç¼–è¯‘ï¼šä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„CPUæ ¸å¿ƒ
          make O=out -j$(nproc --all)
          echo "âœ… Build finished."

      # æ­¥éª¤8ï¼šæ‰“åŒ…ç¼–è¯‘äº§ç‰©
      - name: Package Artifacts
        run: |
          echo "ğŸ“¦ Packaging the kernel image..."
          cd kernel-source/out/arch/arm64/boot/
          # å°†å†…æ ¸é•œåƒæ–‡ä»¶æ‰“åŒ…æˆzip
          zip -r Kernel-realme_gtneo6-$(date +%Y%m%d).zip Image
          echo "ğŸ“¦ Packaging complete."

      # æ­¥éª¤9ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰©
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Image
          # ä¸Šä¼ æ‰“åŒ…å¥½çš„zipæ–‡ä»¶
          path: kernel-source/out/arch/arm64/boot/*.zip
