name: Build MKSU-SUSFS For Realme GT Neo6 (SM8650)
on:
  workflow_dispatch:
   inputs:
      CPUD:
        description: "处理器代号"
        required: true
        default: 'sm8650'
      SUSFS_ENABLED:
        description: "添加 SUSFS"
        required: true
        type: boolean
        default: true
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-gnu-
    
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          
      - name: Configure Git
        run: |
         git config --global user.name "build"
         git config --global user.email "liw378721@gmail.com"

      - name: Install dependencies
        run: |
         sudo apt update && sudo apt upgrade -y
         sudo apt install -y python3 git curl build-essential flex bison libssl-dev libelf-dev
         sudo apt install -y gcc-aarch64-linux-gnu

      - name: Clone kernel source
        run: |
         git clone --depth=1 --branch=master \
           https://github.com/realme-kernel-opensource/realme_gtneo6-AndroidV-kernel-source.git kernel_src

      - name: Clean kernel source
        run: |
         cd kernel_src
         make clean && make mrproper
         find . -name "abi_gki_protected_exports_*" -delete || echo "No protected exports!"
         sed -i 's/ -dirty//g' scripts/setlocalversion

      - name: Set up MKSU
        run: |
         cd kernel_src
         curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/refs/heads/main/kernel/setup.sh" | bash -
         cd KernelSU
         git revert -m 1 $(git log --grep="remove devpts hook" --pretty=format:"%h") -n || echo "Revert skipped"
         KSU_VERSION=$(expr $(git rev-list --count HEAD) "+" 10200)
         echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV
         sed -i "s/DKSU_VERSION=16/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile
         cd ..

      - name: Apply SUSFS patches
        if: github.event.inputs.SUSFS_ENABLED == 'true'
        run: |
           cd kernel_src
           git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1
           git clone https://github.com/TanakaLun/kernel_patches4mksu.git
           
           # 应用核心补丁
           cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch KernelSU/
           cp kernel_patches4mksu/mksu_susfs.patch KernelSU/
           cp susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./
           
           # 应用文件修改
           mkdir -p fs/susfs
           cp -r susfs4ksu/kernel_patches/fs/* fs/susfs/
           cp -r susfs4ksu/kernel_patches/include/linux/* include/linux/

           # 打补丁
           cd KernelSU
           patch -p1 < ../10_enable_susfs_for_ksu.patch || true
           patch -p1 < ../mksu_susfs.patch || true
           cd ..
           patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch || true
           cd kernel_patches4mksu && cp 69_hide_stuff.patch ../
           cd ..
           patch -p1 -F 3 < 69_hide_stuff.patch
           git add -A && git commit -m "Apply SUSFS integration"

      - name: Build kernel
        run: |
         cd kernel_src
         make O=out ARCH=arm64 defconfig
         make -j$(nproc) O=out ARCH=arm64 \
           CROSS_COMPILE=aarch64-linux-gnu- \
           CC="aarch64-linux-gnu-gcc" \
           CLANG_TRIPLE="aarch64-linux-gnu-"
         
      - name: Package AnyKernel3
        run: |
         git clone https://github.com/Kernel-SU/AnyKernel3
         rm -rf AnyKernel3/.git
         cp kernel_src/out/arch/arm64/boot/Image.gz-dtb AnyKernel3/
         cd AnyKernel3 && sed -i "s/device.name=.*/device.name=Realme GT Neo6/" anykernel.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
         name: RealmeGTNeo6_Kernel_${{ env.KSUVER }}
         path: AnyKernel3/*
